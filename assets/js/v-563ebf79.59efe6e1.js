"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[886],{9514:(s,n,a)=>{a.r(n),a.d(n,{default:()=>u});var l=a(3168);const e=(0,l.uE)('<h1 id="插件-plugin" tabindex="-1"><a class="header-anchor" href="#插件-plugin" aria-hidden="true">#</a> 插件（Plugin）</h1><h2 id="为什么使用插件" tabindex="-1"><a class="header-anchor" href="#为什么使用插件" aria-hidden="true">#</a> 为什么使用插件</h2><p><code>Uma</code> 的插件内部机制就是借用了 <code>Koa</code> 的中间件，但是仅有中间件无法满足框架的扩展，另外中间件的配置对于业务多样性解决也偏单一。</p><p><code>Uma</code> 使用插件进行框架层面拓展，不仅可以使用中间件模式进行扩展，还可以采用复合模式对 context、request、response 进行扩展，还可以对中间件的使用场景进行快速开发，例如 results(返回值)、use(无设定场景)、filter(对符合条件的路由加载中间件)、ignore(对符合条件之外的路由加载中间件)、method(对 MethodType 符合的请求加载中间件)</p><h2 id="插件使用" tabindex="-1"><a class="header-anchor" href="#插件使用" aria-hidden="true">#</a> 插件使用</h2><h3 id="插件安装" tabindex="-1"><a class="header-anchor" href="#插件安装" aria-hidden="true">#</a> 插件安装</h3><p>插件可以通过 npm 方式进行安装。<code>Uma</code>官方提供的插件一般使用<code>@umajs/plugin-</code>作为前缀，方便我们去搜索。同时<code>Uma</code>也可以加载应用目录内的用户自定义插件<code>plugins</code>目录。框架在读取配置后，插件的加载优先级如下：</p><ol><li>{URSA_ROOT}/plugins/{packageName}</li><li>{URSA_ROOT}/node_modules/{packageName}</li></ol><h3 id="插件配置" tabindex="-1"><a class="header-anchor" href="#插件配置" aria-hidden="true">#</a> 插件配置</h3><p>插件一般有默认配置，我们也可以通过自定义配置来覆盖原有配置。</p><p>插件的配置在 config 目录下的<code>plugin.config.ts</code>文件中，插件顺序按照 <code>config/plugin.config.ts</code> 配置的顺序进行加载。</p><blockquote><p>注意：插件的顺序会影响到插件调用其它插件的功能。</p></blockquote><h4 id="插件配置说明" tabindex="-1"><a class="header-anchor" href="#插件配置说明" aria-hidden="true">#</a> 插件配置说明</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#0d1117;"><code><span class="line"><span style="color:#FF7B72;">export</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">type</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">TPluginConfig</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> {</span></span>\n<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FFA657;">enable</span><span style="color:#FF7B72;">?:</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">boolean</span><span style="color:#C9D1D9;">        </span><span style="color:#8B949E;">// 是否开启插件，默认值false</span></span>\n<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FFA657;">name</span><span style="color:#FF7B72;">?:</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">string</span><span style="color:#C9D1D9;">           </span><span style="color:#8B949E;">// 插件名，可选</span></span>\n<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FFA657;">packageName</span><span style="color:#FF7B72;">?:</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">string</span><span style="color:#C9D1D9;">    </span><span style="color:#8B949E;">// npm包名，可选，如不填写时，默认值为`@umajs/plugin-$</span></span>\n<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FFA657;">options</span><span style="color:#FF7B72;">?:</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">object</span><span style="color:#C9D1D9;">        </span><span style="color:#8B949E;">// 框架会将此配置用参数形式传给插件</span></span>\n<span class="line"><span style="color:#C9D1D9;">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>当 [pluginName].config.ts 存在时， 会和配置混合后传给插件</p></blockquote><h4 id="插件配置实例" tabindex="-1"><a class="header-anchor" href="#插件配置实例" aria-hidden="true">#</a> 插件配置实例</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#0d1117;"><code><span class="line"><span style="color:#8B949E;">// config/plugin.config.ts</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#FF7B72;">export</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">default</span><span style="color:#FFA657;"> {</span></span>\n<span class="line"><span style="color:#FFA657;">  </span><span style="color:#A5D6FF;">&#39;error-handler&#39;</span><span style="color:#C9D1D9;">: {</span></span>\n<span class="line"><span style="color:#C9D1D9;">    enable: </span><span style="color:#79C0FF;">true</span><span style="color:#C9D1D9;">,</span></span>\n<span class="line"><span style="color:#C9D1D9;">    name: </span><span style="color:#A5D6FF;">&#39;error-handler&#39;</span><span style="color:#C9D1D9;">,</span></span>\n<span class="line"><span style="color:#C9D1D9;">    packageName: </span><span style="color:#A5D6FF;">&#39;@umajs/plugin-error-handler&#39;</span><span style="color:#C9D1D9;">,</span></span>\n<span class="line"><span style="color:#C9D1D9;">    options: {</span></span>\n<span class="line"><span style="color:#C9D1D9;">      foo: </span><span style="color:#A5D6FF;">&#39;1&#39;</span><span style="color:#C9D1D9;">,</span></span>\n<span class="line"><span style="color:#C9D1D9;">    }, </span><span style="color:#8B949E;">// 插件的实际配置</span></span>\n<span class="line"><span style="color:#C9D1D9;">  }</span><span style="color:#FFA657;">,</span></span>\n<span class="line"><span style="color:#FFA657;">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果只需开启插件或关闭插件，可以简化配置写法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#0d1117;"><code><span class="line"><span style="color:#8B949E;">// config/plugin.config.ts</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#FF7B72;">export</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">default</span><span style="color:#FFA657;"> {</span></span>\n<span class="line"><span style="color:#FFA657;">  </span><span style="color:#A5D6FF;">&#39;error-handler&#39;</span><span style="color:#C9D1D9;">: </span><span style="color:#79C0FF;">true</span><span style="color:#FFA657;">,</span></span>\n<span class="line"><span style="color:#FFA657;">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div>',19),p=(0,l.Uk)("插件实际上是一个接收uma对象和option参数的函数，函数必须返回中间件函数或复合插件格式"),o=(0,l.Uk)("对象"),r=(0,l.uE)('<div class="language-typescript ext-ts line-numbers-mode"><pre class="shiki" style="background-color:#0d1117;"><code><span class="line"><span style="color:#8B949E;">// plugin/error-handler/index.ts</span></span>\n<span class="line"><span style="color:#FF7B72;">export</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">default</span><span style="color:#FFA657;"> (uma</span><span style="color:#FF7B72;">:</span><span style="color:#FFA657;"> Uma, options</span><span style="color:#FF7B72;">:</span><span style="color:#FFA657;"> TView </span><span style="color:#FF7B72;">=</span><span style="color:#FFA657;"> {})</span><span style="color:#FF7B72;">:</span><span style="color:#FFA657;"> Koa.Middleware </span><span style="color:#FF7B72;">=&gt;</span><span style="color:#FFA657;"> </span><span style="color:#C9D1D9;">{</span></span>\n<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#8B949E;">// uma 实例化对象；options 插件配置的 options，等同于 uma.plugin[&#39;error-handler&#39;].options</span></span>\n<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">async</span><span style="color:#C9D1D9;">(</span><span style="color:#FFA657;">ctx</span><span style="color:#C9D1D9;">,</span><span style="color:#FFA657;">next</span><span style="color:#C9D1D9;">)</span><span style="color:#FF7B72;">=&gt;</span><span style="color:#C9D1D9;">{</span></span>\n<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">try</span><span style="color:#C9D1D9;">{</span></span>\n<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#FF7B72;">await</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">next</span><span style="color:#C9D1D9;">();</span></span>\n<span class="line"><span style="color:#C9D1D9;">        }</span><span style="color:#FF7B72;">catch</span><span style="color:#C9D1D9;">(e){</span></span>\n<span class="line"><span style="color:#C9D1D9;">          console.</span><span style="color:#D2A8FF;">error</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&#39;error-handler插件捕获异常&#39;</span><span style="color:#C9D1D9;">,e);</span></span>\n<span class="line"><span style="color:#C9D1D9;">        }</span></span>\n<span class="line"><span style="color:#C9D1D9;">    };</span></span>\n<span class="line"><span style="color:#C9D1D9;">};</span></span>\n<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div>',1),c={id:"插件开发",tabindex:"-1"},t=(0,l._)("a",{class:"header-anchor",href:"#插件开发","aria-hidden":"true"},"#",-1),i=(0,l.Uk)(),y=(0,l.Uk)("插件开发"),d={},u=(0,a(6215).Z)(d,[["render",function(s,n){const a=(0,l.up)("RouterLink");return(0,l.wg)(),(0,l.iD)(l.HY,null,[e,(0,l._)("p",null,[p,(0,l.Wm)(a,{to:"/plugin/dev.html#%E5%A4%8D%E5%90%88%E6%8F%92%E4%BB%B6%E5%BD%A2%E5%BC%8F"},{default:(0,l.w5)((()=>[o])),_:1})]),r,(0,l._)("h2",c,[t,i,(0,l.Wm)(a,{to:"/plugin/dev.html"},{default:(0,l.w5)((()=>[y])),_:1})])],64)}]])},8820:(s,n,a)=>{a.r(n),a.d(n,{data:()=>l});const l={key:"v-563ebf79",path:"/development/Plugin.html",title:"插件（Plugin）",lang:"zh-CN",frontmatter:{head:[["meta",{property:"og:url",content:"/development/Plugin.html"}],["meta",{property:"og:site_name",content:"UMajs"}],["meta",{property:"og:title",content:"插件（Plugin）"}],["meta",{property:"og:type",content:"article"}],["meta",{property:"og:locale",content:"zh-CN"}],["meta",{property:"og:locale:alternate",content:"en-US"}],["meta",{name:"twitter:card",content:"summary_large_image"}],["meta",{name:"twitter:image:alt",content:"UMajs"}],["meta",{property:"article:author",content:"wuba"}],["meta",{property:"og:restrictions:age",content:"3+"}]]},excerpt:"",headers:[{level:2,title:"为什么使用插件",slug:"为什么使用插件",children:[]},{level:2,title:"插件使用",slug:"插件使用",children:[{level:3,title:"插件安装",slug:"插件安装",children:[]},{level:3,title:"插件配置",slug:"插件配置",children:[]}]},{level:2,title:"插件开发",slug:"插件开发",children:[]}],filePathRelative:"development/Plugin.md",git:{updatedTime:1634896538e3,contributors:[{name:"BubbleM",email:"bubblelm@163.com",commits:1},{name:"dazjean",email:"zunyi_zjj@163.com",commits:1}]}}},6215:(s,n)=>{n.Z=(s,n)=>{for(const[a,l]of n)s[a]=l;return s}}}]);